<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <META NAME="author" CONTENT="john@coronite.net">
    <!--
  Author: John Coronite
  Email: John@Coronite.net
  Website: coronite.net
  Source Files Available At: https://github.com/jcoro/TileBreaker
  Copyrighted material used in accordance with Fair-Use exemption for education in Title 17 of the U.S. Code Section 107 http://www.copyright.gov/title17/92chap1.html#107
  
  ****Image Credits****
  Character images: http://bulbapedia.bulbagarden.net
  Background and Brick images: http://www.pokemon.com/us/
  Copyright 2016 John Coronite

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.

  You should have received a copy of the GNU General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
    -->
        <link rel="stylesheet" type="text/css" href="../css/styles.css">
        <title>Tile Breaker - Final Game</title>

    </head>
    <body>
        <div class="main_wrapper">
            <div class="title">
                <h1>Tile Breaker</h1>
            </div>
            <div id="left_section">
                <div id="canvas_container">
                </div>
                <div class="wrapper">
                    <div class="button_wrapper">
                        <div class="button_container">
                            <button type="button" id="continueButton" class="myStartButton">Continue</button>
                        </div>
                        <div class="button_container">
                            <button type="button" id="nextLevelButton" class="myStartButton">Next Level</button>
                        </div>
                        <div class="button_container">
                            <button type="button" id="newGameButton" class="myStartButton">New Game</button>
                        </div>
                    </div>
                </div>                
            </div>
            <div id="right_section">
                <div class="scoreboard">
                    <div class="sb-header">
                        <h2>ScoreBoard</h2>
                    </div>
                    <div class="sb-level">
                        <h4>Level: <span id="gameLevel">0</span></h4>
                    </div>
                    <div class="sb-score">
                        <h3>Score: <span id="score">0</span></h3>
                    </div>
                    <div class="sb-characters">
                        <h3>Characters: <span id="characters">0</span></h3>
                    </div>
                    <div class="sb-instructions">
                        <p>
                            Capture all 15 characters in 5 different worlds.
                            Hint: Try to capture the characters before you break all of the tiles - or you'll need to go through each world to find them again!
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </body>
    <script>

        /**
         * GAME CLASS 
         * 
         *  When a game is initialized, it contains the values needed to run the game.
         * 
         */
        function Game() {

            this.brickRows = 3;
            this.brickColumns = 9;
            this.paddleWidth = 168;
            this.paddleHeight = 20;
            this.textColor = "#FFFFFF";
            this.brickImage = new Image();
            this.canvasImage = new Image();
            this.ballImageX = 0; // The ball image has 36 frames - this variable is updated to produce animations
            this.rightPressed = false;
            this.leftPressed = false;
            this.score = 0;
            this.characterScore = 0;
            this.bricksDestroyed = 0;
            this.lives = 3;
            this.gameOver = false;
            this.level = 1;
            this.screenView = 1;
            this.levelFinished = false;
            this.winner = false;
            this.characters = this.createInitialCharactersArray();
            this.bricks = null;
            this.ball = null;
            this.paddle = null;            
        }

            // Game values which don't change during the course of the game:

            Game.prototype.canvasWidth = 780;
            Game.prototype.canvasHeight = 510;
            Game.prototype.ballWidth = 22;
            Game.prototype.ballImage = new Image();
            Game.prototype.initialBackgroundImage = new Image();
            Game.prototype.paddleImage = new Image();
            Game.prototype.winnerImage = new Image ();
            Game.prototype.ballImage.src = "../img/pokeball.png"            
            Game.prototype.initialBackgroundImage.src = "../img/initial-bg.png";
            Game.prototype.paddleImage.src = "../img/paddle.png";
            Game.prototype.winnerImage.src = "../img/winner-bg.png";
            Game.prototype.nextLevelButton = document.getElementById('nextLevelButton');
            Game.prototype.newGameButton = document.getElementById('newGameButton');
            Game.prototype.continueButton = document.getElementById('continueButton');
            Game.prototype.levelDiv = document.getElementById('gameLevel'); 
            Game.prototype.scoreSpan = document.getElementById('score');
            Game.prototype.characterSpan = document.getElementById('characters');

            Game.prototype.createInitialCharactersArray = function() {

            var gameCharacters = 
                [
                    {
                        image: '../img/bulbasaur.png',
                        onScreen : 1,
                        name : "bulbasaur"
                    },
                    {
                        image : '../img/chikorita.png',
                        onScreen : 1,
                        name : "chikorita"
                    },
                    {
                        image : '../img/tangela.png',
                        onScreen : 1,
                        name : "tangela"
                    },
                    {
                        image : '../img/cubchoo.png',
                        onScreen : 2,
                        name : "cubchoo"
                    },
                    {
                        image : '../img/regice.png',
                        onScreen : 2,
                        name : "regice"
                    },
                    {
                        image : '../img/glaceon.png',
                        onScreen : 2,
                        name : "glaceon"
                    },
                    {
                        image : '../img/charmander.png',
                        onScreen : 3,
                        name : "charmander"
                    },
                    {
                        image : '../img/ponyta.png',
                        onScreen : 3,
                        name : "ponyta"
                    },
                    {
                        image : '../img/slugma.png',
                        onScreen : 3,
                        name : "slugma"
                    },
                    {
                        image : '../img/squirtle.png',
                        onScreen : 4,
                        name : "squirtle"
                    },
                    {
                        image : '../img/golduck.png',
                        onScreen : 4,
                        name : "golduck"
                    },
                    {
                        image : '../img/poliwhirl.png',
                        onScreen : 4,
                        name : "poliwhirl"
                    },
                    {
                        image : '../img/nosepass.png',
                        onScreen : 5,
                        name : "nosepass"
                    },
                    {
                        image : '../img/regirock.png',
                        onScreen : 5,
                        name : "regirock"
                    },
                    {
                        image : '../img/gigalith.png',
                        onScreen : 5,
                        name : "gigalith"
                    }

                ];

                var characterArray = [];
                for (i=0; i < gameCharacters.length; i++){
                    characterArray[i] = new Character(1, gameCharacters[i].image, gameCharacters[i].onScreen, gameCharacters[i].name )
                };

                    return characterArray;       
            }; 

            Game.prototype.createBricksArray = function() {
                var brickArray = [];
                for(c=0; c<this.brickRows; c++) {
                    brickArray[c] = [];
                    for(r=0; r<this.brickColumns; r++) {
                        brickArray[c][r] = new Brick(1);
                    }
                } 
                return brickArray;       
            }; 

            Game.prototype.collisionDetection = function() {
                for(c=0; c<this.brickRows; c++) {
                    for(r=0; r<this.brickColumns; r++) {
                        var b = game.bricks[c][r];
                        if(b.status == 1) {
                            if((this.ball.x+this.ball.width) > b.x && (this.ball.x-this.ball.width) < b.x+b.width && (this.ball.y+this.ball.width) > b.y && (this.ball.y-this.ball.width) < b.y+b.height) {
                                this.ball.dy = -this.ball.dy;
                                b.status = 0;
                                this.score++;
                                game.scoreSpan.innerHTML = this.score;
                                this.bricksDestroyed++;
                                if(this.bricksDestroyed == this.brickColumns*this.brickRows) {
                                    this.levelFinished = true;                            
                                }
                            }
                        }
                    }
                }
            }

            Game.prototype.collisionDetectionCharacters = function() {
                for(c=0; c<this.characters.length; c++) {
                    var charac = this.characters[c];
                    if(charac.status == 1 && charac.captured == false && charac.showScreen == game.screenView) {
                        if((this.ball.x+this.ball.width) > charac.x && (this.ball.x-this.ball.width) < charac.x+charac.width && (this.ball.y+this.ball.width) > charac.y && (this.ball.y-this.ball.width) < charac.y+charac.height) {
                            this.ball.dy = -this.ball.dy;
                            charac.status = 0;
                            charac.captured = true;
                            this.characterScore++;
                            this.characterSpan.innerHTML = this.characterScore;
                            if(this.characterScore == this.characters.length){
                                this.winner = true;
                            }
                        }
                    }                    
                }
            }  

            Game.prototype.createRandomX = function(){
                return (Math.abs((Math.round(Math.random() * this.canvasWidth)) - (3 * this.ballWidth)));
            };                                 
                           
        var game = new Game();
        
        /**
         * GAME OBJECTS
         */

        var display;

        window.onload = function () {
            
        // Create game canvas on page load
            display = new Screen(game.canvasWidth, game.canvasHeight);
            display.drawImage(game.initialBackgroundImage);  
        }


        /**
         * CANVAS CLASS 
         * 
         * @param {number} width - width of canvas in pixels
         * @param {number} height - height of canvas in pixels
         */
        function Screen(width, height) {
            // create canvas and grab 2d context
            this.canvas = document.createElement("canvas");
            this.canvas.width = this.width = width;
            this.canvas.height = this.height = height;
            this.ctx = this.canvas.getContext("2d");
            canvasContainer = document.getElementById('canvas_container');
            // append canvas to the canvas container
            canvasContainer.appendChild(this.canvas);
        };

        /**
         * Draw the background image on the canvas
         */
        Screen.prototype.drawImage = function(image) {
            this.ctx.drawImage(image, 0, 0);
        };     

        /**
         * Clear the complete canvas
         */
        Screen.prototype.clear = function() {
            this.ctx.clearRect(0, 0, this.width, this.height);
        };

        /**
         * Draw a ball on the screen
         */
        Screen.prototype.drawBall = function(image) {
            //parameters are: image, clip-x, clip-y, width of img, height of img, canvas-x, canvas-y, width of img, height of img
            this.ctx.drawImage(image, game.ballImageX, 0, 22, 22, game.ball.x, game.ball.y, 22, 22);
            if (game.ballImageX < 770){
               game.ballImageX = game.ballImageX + 22; 
            } else {
                game.ballImageX = 0;
            }
        };

        /**
         * Draw a the bricks on the screen
         */        
        Screen.prototype.drawBricks = function() {
            for(c=0; c<game.brickRows; c++) {
                for(r=0; r<game.brickColumns; r++) {
                    if(game.bricks[c][r].status == 1) {                    
                        var brickX = (r*(game.bricks[c][r].width+game.bricks[c][r].padding))+game.bricks[c][r].offsetLeft;
                        var brickY = (c*(game.bricks[c][r].height+game.bricks[c][r].padding))+game.bricks[c][r].offsetTop;
                        game.bricks[c][r].x = brickX;
                        game.bricks[c][r].y = brickY;
                        display.ctx.drawImage(game.bricks[c][r].image, brickX, brickY)
                    }
                }
            }  
        };     

        /**
         * Draw Characters on the screen
         */        
        Screen.prototype.drawCharacters = function() {
            var counter = 0;
            for(c=0; c<game.characters.length; c++) {   
                if (game.characters[c].status == 1 && game.characters[c].captured == false && game.characters[c].showScreen == game.screenView) {  
                    if(!game.characters[c].position){
                        var characterX = (counter*(display.width/3)+((display.width/3)-(game.characters[c].width))/2);
                    } else {
                        characterX = game.characters[c].position;
                    }
                        var characterY = game.characters[c].padding+game.characters[c].offsetTop;
                        game.characters[c].x = characterX;
                        game.characters[c].y = characterY;

                        var img = new Image();
                        img.src = game.characters[c].image;
                        display.ctx.drawImage(img, characterX, characterY);
                        counter++;
                        game.characters[c].position = characterX;
                }
            }  
        };            

        Screen.prototype.drawPaddle = function() {
            //parameters are: image, clip-x, clip-y, width of img, height of img, canvas-x, canvas-y, width of img, height of img
            this.ctx.drawImage(
                game.paddleImage,             
                game.paddle.clipX,
                game.paddle.clipY,
                game.paddle.width,
                game.paddle.height,
                game.paddle.x,
                game.paddle.y,
                game.paddle.width,
                game.paddle.height
            );
        };

        Screen.prototype.drawScore = function() {
            display.ctx.font = "16px Arial";
            display.ctx.fillStyle = game.textColor;
            display.ctx.fillText("Score: "+game.score, 8, 20);
        };

        Screen.prototype.drawLives = function() {
            display.ctx.font = "16px Arial";
            display.ctx.fillStyle = game.textColor;
            display.ctx.fillText("Lives: "+game.lives, display.canvas.width-65, 20);
        };

        Screen.prototype.drawMessage = function(text) {
            display.ctx.font = "bold 38px Arial";
            display.ctx.fillStyle = game.textColor;
            var width = display.ctx.measureText(text).width
            display.ctx.fillText(text, ((display.canvas.width-width)/2), display.canvas.height/2);
        };         


        /**
         * BALL CLASS 
         * 
         * @param {number} positionX - x Position of the ball image (at its upper-left)
         * @param {number} positionY - y Position of the ball image (at its upper-left)
         * @param {number} width - Width of the ball image
         */

        function Ball(positionX, positionY, width) {
            this.x = positionX;
            this.y = positionY;
            this.width = width;
            this.dx = 3;
            this.dy = -3;
        };


        /**
         * PADDLE CLASS 
         * 
         * @param {number} canvasWidth - the canvas width
         * @param {number} canvasHeight - the canvas height
         * @param {number} width - the width of the paddle
         * @param {number} height - the height of the paddle
         * @param {number} clipY - how much of the Y value to clip (from the top)
         * @param {number} clipX - how much of the X value to clip (from the left)
         */
        function Paddle(canvasWidth, canvasHeight, width, height, clipY, clipX) {
            this.x = (canvasWidth/2) - (width/2);
            this.y = canvasHeight - height;
            this.width = width;
            this.height = height;
            this.clipY = clipY;
            this.clipX = clipX;
        };  

        // Perform this when the mouse moves
        Paddle.prototype.mouseMoveHandler = function(e) {
            var relativeX = e.clientX - display.canvas.offsetLeft;
            if(relativeX > 0 && relativeX < game.canvasWidth) {
                game.paddle.x = relativeX - (game.paddle.width)/2;                
            } 
        } 

        // Perform this when the left arrow is pressed
        Paddle.prototype.keyDownHandler = function(e) {
            if(e.keyCode == 39) {
                game.rightPressed = true;
            }
            else if(e.keyCode == 37) {
                game.leftPressed = true;
            }
        };

        // Perform this when the right arrow is pressed
        Paddle.prototype.keyUpHandler = function(e) {
            if(e.keyCode == 39) {
                game.rightPressed = false;
            }
            else if(e.keyCode == 37) {
                game.leftPressed = false;
            }
        }        


        /**
         * BRICK CLASS 
         * 
         * @param {number} status - the status of the brick, 1 means draw it, 0 means don't
         *   
         */
        function Brick(status) {
            this.status = status;
            this.x = null;
            this.y = null;
        }; 

        Brick.prototype.width = 66;
        Brick.prototype.height = 22;
        Brick.prototype.padding = 10;
        Brick.prototype.offsetLeft = 30;
        Brick.prototype.offsetTop = 175;
        Brick.prototype.image = game.brickImage;


        /**
         * CHARACTER CLASS 
         * 
         * @param {number} status - the status of the Character, 1 means draw it, 0 means don't
         * @param {string} image - a reference to the image
         * @param {number} screenNumber - a number indicating on which screen the image is to be displayed 
         * @param {string} name - the name of the Character
         * @param {number} x - the x value of the Character (upper-left corner)
         * @param {number} y - the y value of the Character (upper-left corner)
         */
        function Character(status, image, screenNumber, name) {
            this.status = status;
            this.image = image;
            this.showScreen = screenNumber;
            this.name = name;
            this.captured = false;
            this.position = null;
            this.x = 0;
            this.y = 0;
        }; 

        Character.prototype.width = 100;
        Character.prototype.height = 100;
        Character.prototype.padding = 10;
        Character.prototype.offsetLeft = 30;
        Character.prototype.offsetTop = 30;       


        /**
        * HELPER FUNCTIONS
        *
        */      

        function levelChanges() {
            if (game.level == 1) {
                // these are the values for LEVEL 1 - We don't need to change these.
                game.brickRows = 3;
                game.ball.dx = 3;
                game.ball.dy = -3;

            } else if (game.level == 2) {
                // ADD a ROW of BRICKS on LEVEL 2
                game.brickRows = 4;
                // Make the BALL move FASTER on LEVEL 2
                game.ball.dx = 6;
                game.ball.dy = -6;

            } else if (game.level == 3){                
                game.ball.dx = 6;
                game.ball.dy = -6;

                //make the PADDLE SMALLER on level 3
                game.paddle.width = 104;
                game.paddle.clipY = 20;
                game.paddle.clipX = 32;

            } else if (game.level == 4) {
                game.ball.dx = 6;
                game.ball.dy = -6;

                //make the PADDLE EVEN SMALLER on level 4
                game.paddle.width = 72;
                game.paddle.clipY = 40;
                game.paddle.clipX = 48;

            } else {
                // For all levels ABOVE LEVEL 4, Make the BALL move EVEN FASTER
                game.ball.dx = 7
                game.ball.dy = -7;       
            }

        }        

        function screenChanges() {
            switch(game.screenView) {
                case 1:
                    game.brickImage.src="../img/grass.png"; 
                    game.canvasImage.src = "../img/grass-bg.png";
                    game.textColor = "#000000";
                    break;
                case 2:
                    game.brickImage.src="../img/ice.png"; 
                    game.canvasImage.src = "../img/ice-bg.png";
                    game.textColor = "#000000";
                    break;
                case 3:
                    game.brickImage.src="../img/fire.png"; 
                    game.canvasImage.src = "../img/fire-bg.png";
                    game.textColor = "#FFFFFF";
                    break; 
                case 4:
                    game.brickImage.src="../img/water.png"; 
                    game.canvasImage.src = "../img/beach-bg.png";
                    game.textColor = "#000000";
                    break;  
                case 5:
                    game.brickImage.src="../img/rock.png"; 
                    game.canvasImage.src = "../img/cave-bg.png";
                    game.textColor = "#FFFFFF";
                    break;                                                           
                default:
                    game.brickImage.src="../img/grass.png"; 
                    game.canvasImage.src = "../img/grass-bg.png";
                    game.textColor = "#000000";

            }
        }
        

        /**
        * INITIALIZER FUNCTIONS
        *
        */
        function initNewGame() {  
            game.gameOver = false;
            game.level = 1;
            game.screenView = 1;
            game.lives = 3;
            game.score = 0;
            game.characterScore = 0;
            game.bricksDestroyed = 0;
            game.levelFinished = false;
            game.winner = false;
            game.levelDiv.innerHTML = game.level.toString(); 
            game.ball = new Ball( game.createRandomX(), game.canvasHeight-game.paddleHeight-game.ballWidth, game.ballWidth);  
            levelChanges();
            screenChanges();
            game.paddle = new Paddle( game.canvasWidth, game.canvasHeight, game.paddleWidth, game.paddleHeight, 0, 0 );
            document.addEventListener("mousemove", game.paddle.mouseMoveHandler, false); 
            document.addEventListener("keydown", game.paddle.keyDownHandler, false);
            document.addEventListener("keyup", game.paddle.keyUpHandler, false);             
            game.bricks = game.createBricksArray();
            game.characters = game.createInitialCharactersArray();
            draw();            
        }

        function initContinueGame() {
            game.continueButton.style = "display:none";
            game.ball = new Ball( game.createRandomX(), game.canvasHeight-game.paddleHeight-game.ballWidth, game.ballWidth); 
            levelChanges();
            draw();
        }

        function initNextLevel() {
            game.nextLevelButton.style = "display:none"; 
            game.level++; 
            if(game.screenView == 5){
              game.screenView = 1;  
            } else {
              game.screenView++    
            }         
            game.levelDiv.innerHTML = game.level.toString();             
            game.gameOver = false;
            game.levelFinished = false;            
            game.bricksDestroyed = 0;
            display.drawBricks(); 
            game.ball = new Ball( game.createRandomX(), game.canvasHeight-game.paddleHeight-game.ballWidth, game.ballWidth);            
            levelChanges();
            screenChanges();
            game.bricks = game.createBricksArray();
            display.drawCharacters();
            draw();
        }   


        /*
        * The draw function below is called repeatedly with the line:
        * requestAnimationFrame(draw);
        * method within it. This is called only if the game isn't over, or a level hasn't just been finished.
        *
        */

        function draw() {
            if (!game.gameOver && !game.levelFinished && !game.winner) {
                display.ctx.clearRect(0, 0, display.canvas.width, display.canvas.height);
                display.drawImage(game.canvasImage);
                display.drawBricks();
                display.drawCharacters();
                display.drawBall(game.ballImage);
                display.drawPaddle();
                display.drawScore();
                display.drawLives();
                game.collisionDetection(); 
                game.collisionDetectionCharacters();
                // Bounce ball off the left or right of the canvas
                if(game.ball.x + game.ball.dx > display.canvas.width-game.ball.width || game.ball.x + game.ball.dx < 0) {
                    game.ball.dx = -game.ball.dx;
                }
                // Bounce ball off the top of the canvas
                if(game.ball.y + game.ball.dy < 0) {
                    game.ball.dy = -game.ball.dy;
                }
                // If the edge of the ball is past the edge of the paddle...
                else if((game.ball.y+game.ball.width) + game.ball.dy > display.canvas.height-game.paddle.height) {
                    // This if statement tests if the ball hits the paddle
                    if(game.ball.x > (game.paddle.x-game.ball.width) && game.ball.x < (game.paddle.x + game.paddle.width+game.ball.width)) {
                        game.ball.dy = -game.ball.dy;
                    }
                    else {
                        game.lives--;
                        if(!game.lives) {                    
                            game.gameOver = true;
                        }
                        else {
                            game.continueButton.style = "display:block";                        
                            return;
                        }
                    }
                }
                if(game.rightPressed && game.paddle.x < display.canvas.width-game.paddle.width) {
                    game.paddle.x += 14;
                }
                else if(game.leftPressed && game.paddle.x > 0) {
                    game.paddle.x -= 14;
                }
                game.ball.x += game.ball.dx;
                game.ball.y += game.ball.dy;
                requestAnimationFrame(draw);
            } else {
                if (game.gameOver){
                    display.ctx.clearRect(0, 0, display.canvas.width, display.canvas.height);
                    display.drawImage(game.canvasImage);
                    display.drawScore();
                    display.drawLives();
                    display.drawCharacters(game.screenView);
                    display.drawBricks(game.bricks);
                    display.drawBall(game.ballImage);
                    display.drawPaddle();
                    display.drawMessage("GAME OVER");                
                    game.nextLevelButton.style = "display:none"  
                } else if (game.levelFinished) {
                    display.ctx.clearRect(0, 0, display.canvas.width, display.canvas.height);
                    display.drawImage(game.canvasImage);
                    display.drawScore(); 
                    display.drawLives(); 
                    display.drawCharacters(game.screenView);              
                    display.drawMessage("LEVEL FINISHED");
                    game.nextLevelButton.style = "display:block";              
                }else if (game.winner) {
                    display.ctx.clearRect(0, 0, display.canvas.width, display.canvas.height);
                    display.drawImage(game.winnerImage);
                    game.textColor = "#000000";
                    display.drawScore(); 
                    display.drawLives();
                }
                
            }
        } 

        game.nextLevelButton.onclick = function() { 
            initNextLevel();
        }

        game.continueButton.onclick = function() {  
            initContinueGame();
        }

        game.newGameButton.onclick = function() {    
            initNewGame();
        }      
    </script>
</html>